---
import { X, Terminal, Package } from 'lucide-astro';
---

<!-- Download Modal Overlay -->
<div id="download-modal" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-4 bg-background/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
    <!-- Main Window/Box -->
    <div class="w-full max-w-5xl h-auto max-h-[85vh] bg-card/90 backdrop-blur-md border border-border rounded-xl shadow-2xl shadow-black/50 flex flex-col overflow-hidden relative transform scale-95 transition-transform duration-300" id="modal-box">
        
        <!-- Window Header / Controls -->
        <div class="flex-none px-4 py-3 border-b border-border bg-muted/50 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <!-- Close Control (Red X) -->
                <button id="close-x" class="group flex items-center justify-center w-5 h-5 rounded-md hover:bg-destructive/20 transition-colors cursor-pointer" title="Close Window">
                    <X class="w-3.5 h-3.5 text-destructive group-hover:scale-110 transition-transform" />
                </button>
                <div class="ml-3 text-[10px] font-mono text-muted-foreground opacity-70 select-none">SECURE_UPLINK</div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col min-h-0 relative p-6 md:p-8">
            
            <!-- Loading State -->
            <div id="loading" class="flex flex-col items-center justify-center min-h-[400px] w-full space-y-4 animate-in fade-in duration-300">
                <div class="w-12 h-12 border-4 border-muted border-t-secondary rounded-full animate-spin"></div>
                <p class="font-mono text-secondary animate-pulse text-sm tracking-widest">ESTABLISHING CONNECTION...</p>
            </div>

            <!-- Error State -->
            <div id="error" class="hidden flex-col items-center justify-center min-h-[400px] w-full text-center animate-in fade-in duration-300">
                <div class="p-4 bg-destructive/10 border border-destructive/20 rounded-full mb-4">
                    <Terminal class="w-8 h-8 text-destructive" />
                </div>
                <h2 class="text-xl font-bold text-destructive mb-2 tracking-tight">SIGNAL LOST</h2>
                <p class="text-muted-foreground text-sm mb-6">Target repository unreachable.</p>
                <button id="retry-btn" class="px-6 py-2 bg-destructive text-destructive-foreground hover:bg-destructive/90 rounded text-xs font-bold uppercase tracking-widest transition-colors shadow-lg shadow-destructive/20 cursor-pointer">
                    Retry Uplink
                </button>
            </div>

            <!-- Release Content -->
            <div id="release-content" class="hidden flex-1 flex-col min-h-0 opacity-0 transition-opacity duration-500">
                
                <!-- Top Info -->
                <div class="flex-none flex flex-row items-center justify-between gap-4 mb-6 border-b border-border/50 pb-6">
                    <!-- Left: Version Name -->
                    <h1 id="release-name" class="text-3xl font-bold tracking-tight text-foreground font-sans"></h1>

                    <!-- Right: Status & Date -->
                    <div class="flex items-center gap-3">
                        <span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-secondary text-secondary-foreground uppercase tracking-wider">Latest Stable</span>
                        <span id="release-date" class="text-xs text-muted-foreground font-mono"></span>
                    </div>
                </div>

                <div class="flex-1 flex flex-col lg:flex-row gap-8 min-h-0">
                    <!-- Scrollable Notes -->
                    <div class="flex-1 flex flex-col min-h-0 bg-background/50 rounded-lg border border-border overflow-hidden relative group">
                        <div class="flex-none px-4 py-2 border-b border-border bg-muted/30 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <Terminal class="w-3 h-3 text-muted-foreground" />
                                <span class="text-[10px] font-mono text-muted-foreground uppercase tracking-wider">RELEASE_NOTES.MD</span>
                            </div>
                        </div>
                        <!-- Scroll container -->
                        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-muted-foreground/20 scrollbar-track-transparent hover:scrollbar-thumb-muted-foreground/40">
                            <div id="release-body" class="prose prose-invert prose-blue prose-sm max-w-none 
                                prose-headings:font-sans prose-headings:font-bold prose-headings:text-foreground 
                                prose-h1:text-xl prose-h2:text-lg prose-h3:text-base
                                prose-p:text-muted-foreground prose-p:leading-relaxed
                                prose-a:text-secondary hover:prose-a:text-secondary/80 
                                prose-code:text-primary prose-code:bg-primary/10 prose-code:px-1 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
                                prose-pre:bg-background prose-pre:border prose-pre:border-border
                                prose-ul:text-muted-foreground prose-li:marker:text-secondary"></div>
                        </div>
                    </div>

                    <!-- Sidebar Assets -->
                    <div class="flex-none w-full lg:w-72 flex flex-col gap-4">
                        <h3 class="font-bold text-xs flex items-center gap-2 text-foreground uppercase tracking-widest font-mono opacity-80">
                            <Package class="w-3 h-3 text-secondary" />
                            Artifacts
                        </h3>
                        <div id="assets-list" class="flex flex-col gap-2 overflow-y-auto max-h-[150px] lg:max-h-none pr-1">
                            <!-- Assets injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    import { parse } from 'marked';
    
    // UI Elements
    const modal = document.getElementById('download-modal');
    const modalBox = document.getElementById('modal-box');
    const initBtn = document.getElementById('init-btn');
    const closeBtn = document.getElementById('close-x');
    const retryBtn = document.getElementById('retry-btn');
    
    // Data Elements
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const content = document.getElementById('release-content');
    const releaseName = document.getElementById('release-name');
    const releaseDate = document.getElementById('release-date');
    const releaseBody = document.getElementById('release-body');
    const assetsList = document.getElementById('assets-list');
    const githubLink = document.getElementById('github-link');
    
    const REPO = 'jR4dh3y/Pico32';
    let hasLoaded = false;

    // Functions
    function openModal() {
        if (modal) {
            modal.classList.remove('pointer-events-none', 'opacity-0');
            modalBox?.classList.remove('scale-95');
            modalBox?.classList.add('scale-100');
            
            if (!hasLoaded) {
                fetchLatestRelease();
            }
        }
    }

    function closeModal() {
        if (modal) {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modalBox?.classList.remove('scale-100');
            modalBox?.classList.add('scale-95');
        }
    }

    async function fetchLatestRelease() {
        // Reset states
        loading?.classList.remove('hidden');
        error?.classList.add('hidden');
        content?.classList.add('hidden');
        
        try {
            const response = await fetch(`https://api.github.com/repos/${REPO}/releases/latest`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            // Populate Data
            if (releaseName) releaseName.textContent = data.name || data.tag_name;
            if (releaseDate) releaseDate.textContent = new Date(data.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            
            // Parse and render Markdown body
            if (releaseBody) {
                const parsedBody = parse(data.body);
                if (parsedBody instanceof Promise) {
                    releaseBody.innerHTML = await parsedBody;
                } else {
                    releaseBody.innerHTML = parsedBody;
                }
            }
            
            if (githubLink) (githubLink as HTMLAnchorElement).href = data.html_url;

            // Assets
            if (assetsList) {
                assetsList.innerHTML = '';
                data.assets.forEach((asset: any) => {
                    const isBin = asset.name.endsWith('.bin');
                    
                    const el = document.createElement('a');
                    el.href = asset.browser_download_url;
                    el.className = `flex items-center gap-3 p-3 rounded-lg border border-border bg-background/50 hover:bg-secondary/5 hover:border-secondary/30 transition-all group`;
                    
                    el.innerHTML = `
                        <div class="p-2 rounded-md bg-muted/50 group-hover:bg-secondary/10 text-muted-foreground group-hover:text-secondary transition-colors">
                            ${isBin ? '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3 3"/></svg>' : 
                              '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-xs truncate text-foreground group-hover:text-secondary transition-colors font-mono">${asset.name}</div>
                            <div class="text-[10px] text-muted-foreground font-mono mt-0.5">${(asset.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    `;
                    assetsList.appendChild(el);
                });

                // Source Code Zip
                const sourceEl = document.createElement('a');
                sourceEl.href = data.zipball_url;
                sourceEl.className = `flex items-center gap-3 p-3 rounded-lg border border-border bg-background/50 hover:bg-foreground/5 transition-all group opacity-70 hover:opacity-100`;
                sourceEl.innerHTML = `
                        <div class="p-2 rounded-md bg-muted/50 group-hover:bg-foreground/10 text-muted-foreground group-hover:text-foreground transition-colors">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m10 13-2 2 2 2"/><path d="m14 17 2-2-2-2"/></svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-xs truncate text-foreground group-hover:text-foreground transition-colors font-mono">Source Code</div>
                            <div class="text-[10px] text-muted-foreground font-mono mt-0.5">ZIP Archive</div>
                        </div>
                `;
                assetsList.appendChild(sourceEl);
            }

            // Success state
            hasLoaded = true;
            loading?.classList.add('hidden');
            content?.classList.remove('hidden');
            content?.classList.add('flex');
            content?.classList.remove('opacity-0');
            
        } catch (e) {
            console.error(e);
            loading?.classList.add('hidden');
            error?.classList.remove('hidden');
            error?.classList.add('flex');
        }
    }

    // Event Listeners
    if (initBtn) {
        initBtn.addEventListener('click', openModal);
    }
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    
    if (retryBtn) {
        retryBtn.addEventListener('click', fetchLatestRelease);
    }
    
    // Close on background click
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
    }
    
    // Close on escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
</script>
